#!/usr/bin/make -f

# Explicitly use Python 3.10
PYTHON = python3.10

%:
	dh $@ --with python3,sphinxdoc --buildsystem=pybuild

# Set Python version for pybuild
override_dh_auto_configure:
	dh_auto_configure -- -DPYTHON_EXECUTABLE:FILEPATH=/usr/bin/$(PYTHON) \
		-DPYTHON_LIBRARY:FILEPATH=/usr/lib/$(PYTHON)/config-3.10-x86_64-linux-gnu/lib$(PYTHON).so \
		-DPYTHON_INCLUDE_DIR:PATH=/usr/include/$(PYTHON) \
		-DPython_EXECUTABLE=/usr/bin/$(PYTHON) \
		-DPython_LIBRARY=/usr/lib/$(PYTHON)/config-3.10-x86_64-linux-gnu/lib$(PYTHON).so \
		-DPython_INCLUDE_DIR=/usr/include/$(PYTHON) \
		-DPython3_EXECUTABLE=/usr/bin/$(PYTHON) \
		-DPython3_LIBRARY=/usr/lib/$(PYTHON)/config-3.10-x86_64-linux-gnu/lib$(PYTHON).so \
		-DPython3_INCLUDE_DIR=/usr/include/$(PYTHON)

# Build using setup.py
override_dh_auto_build:
	echo "Running build with $(PYTHON)..."
	$(PYTHON) setup.py build

# Install the package
override_dh_auto_install:
	dh_auto_install -- --install-layout=deb

# Build documentation
override_dh_auto_build-arch:
	dh_auto_build
	# Build Sphinx documentation if it exists
	if [ -d docs ] && [ -f docs/conf.py ]; then \
		sphinx-build -b html docs docs/_build/html; \
	fi

# Install documentation
override_dh_installdocs:
	dh_installdocs
	# Install Sphinx documentation if it was built
	if [ -d docs/_build/html ]; then \
		mkdir -p debian/robodsl-doc/usr/share/doc/robodsl-doc; \
		cp -a docs/_build/html/* debian/robodsl-doc/usr/share/doc/robodsl-doc/; \
	fi

# Clean up build artifacts
override_dh_auto_clean:
	dh_auto_clean
	rm -rf build/ *.egg-info/ .pytest_cache/ .coverage htmlcov/ \
		docs/_build/ docs/api/ .mypy_cache/ .pylint.d/

# Don't run tests during package build
override_dh_auto_test:
	echo "Skipping tests during package build"

# Ensure Python 3 shebang is used
override_dh_python3:
	dh_python3 --shebang=/usr/bin/python3

# Don't run sphinx-build in parallel as it can cause race conditions
override_dh_auto_build-indep:
	dh_auto_build -i -- sphinx-build -j1
