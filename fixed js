document.addEventListener('DOMContentLoaded', function() {
    // Toggle submenus
    const menuItems = document.querySelectorAll('.has-submenu > a');
    
    menuItems.forEach(item => {
        item.addEventListener('click', function(e) {
            const submenu = this.nextElementSibling;
            if (submenu && submenu.classList.contains('submenu')) {
                e.preventDefault();
                const parent = this.parentElement;
                parent.classList.toggle('active');
            }
        });
    });

    // Highlight active menu item based on scroll position
    const sections = document.querySelectorAll('section[id]');
    const menuLinks = document.querySelectorAll('.menu a[href^="#"]');
    
    function highlightMenu() {
        let current = '';
        
        sections.forEach(section => {
            const sectionTop = section.offsetTop - 100;
            if (window.scrollY >= sectionTop) {
                current = '#' + section.getAttribute('id');
            }
        });
        
        menuLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === current) {
                link.classList.add('active');
                
                // Expand parent menu if in a submenu
                const parentMenu = link.closest('.submenu');
                if (parentMenu) {
                    parentMenu.previousElementSibling.classList.add('active');
                    parentMenu.style.display = 'block';
                }
            }
        });
    }
    
    window.addEventListener('scroll', highlightMenu);
    highlightMenu(); // Run once on load
    
    // Smooth scrolling for anchor links - FIXED: Only target actual anchor links
    document.querySelectorAll('a[href^="#"]:not([href="#"])').forEach(anchor => {
        anchor.addEventListener('click', function(e) {
            const targetId = this.getAttribute('href');
            const targetElement = document.querySelector(targetId);
            
            // Only prevent default if the target element exists on current page
            if (targetElement) {
                e.preventDefault();
                window.scrollTo({
                    top: targetElement.offsetTop - 80,
                    behavior: 'smooth'
                });
                
                // Update URL without page jump
                if (history.pushState) {
                    history.pushState(null, null, targetId);
                } else {
                    location.hash = targetId;
                }
            }
            // If target doesn't exist, let the link work normally (go to another page)
        });
    });
    
    // Search functionality
    const searchInput = document.getElementById('search');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const menuItems = document.querySelectorAll('.menu li');
            
            menuItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = '';
                    // Expand parent menus if this is a submenu item
                    const submenu = item.closest('.submenu');
                    if (submenu) {
                        submenu.style.display = 'block';
                        submenu.previousElementSibling.classList.add('active');
                    }
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }
    
    // Responsive menu toggle (for mobile)
    const menuToggle = document.createElement('button');
    menuToggle.className = 'menu-toggle';
    menuToggle.innerHTML = '<i class="fas fa-bars"></i>';
    document.querySelector('header').appendChild(menuToggle);
    
    menuToggle.addEventListener('click', function() {
        document.getElementById('sidebar').classList.toggle('active');
    });
    
    // Close menu when clicking outside on mobile
    document.addEventListener('click', function(e) {
        const sidebar = document.getElementById('sidebar');
        if (!e.target.closest('#sidebar') && !e.target.closest('.menu-toggle')) {
            sidebar.classList.remove('active');
        }
    });
    
    // Add copy button to code blocks
    document.querySelectorAll('pre').forEach(pre => {
        const button = document.createElement('button');
        button.className = 'copy-button';
        button.innerHTML = '<i class="far fa-copy"></i>';
        button.title = 'Copy to clipboard';
        
        button.addEventListener('click', function() {
            const code = pre.querySelector('code').textContent;
            navigator.clipboard.writeText(code).then(() => {
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-check"></i>';
                this.classList.add('copied');
                setTimeout(() => {
                    this.innerHTML = originalText;
                    this.classList.remove('copied');
                }, 2000);
            });
        });
        
        pre.style.position = 'relative';
        pre.appendChild(button);
    });
});

// Add CSS for copy button
const style = document.createElement('style');
style.textContent = `
.copy-button {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: rgba(0, 0, 0, 0.1);
    border: none;
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
    cursor: pointer;
    color: var(--text);
    transition: all 0.2s ease;
}

.copy-button:hover {
    background: rgba(0, 0, 0, 0.2);
}

.copy-button.copied {
    background: #10b981;
    color: white;
}

.menu-toggle {
    display: none;
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    margin-left: auto;
}

@media (max-width: 768px) {
    .menu-toggle {
        display: block;
    }
    
    #sidebar {
        position: fixed;
        top: 0;
        left: -300px;
        width: 280px;
        height: 100vh;
        z-index: 1000;
        transition: left 0.3s ease;
    }
    
    #sidebar.active {
        left: 0;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
    }
    
    .container {
        grid-template-columns: 1fr;
    }
    
    #content {
        margin-left: 0;
    }
}
`;
document.head.appendChild(style);